"use client";
import "./style.scss";
import { useContext, useRef, useState, useMemo } from "react";
import { CartContext } from "@/cart/add/cart";
import "react-phone-input-2/lib/style.css";
import PhoneInput from "react-phone-input-2";
import Link from "next/link";

const CheckoutPage = () => {
  const [selectedMethod, setSelectedMethod] = useState("pickup");
  const [loading, setLoading] = useState(false);
  const {
    cartItems,
    removeFromCart,
    clearCart,
    addOne,
    deleteOne,
    calculateTotalPrice,
    hasSticks,
  } = useContext(CartContext);
  const totalPrice = useMemo(() => calculateTotalPrice(), [cartItems]);
  const formRef = useRef(null);
  const [formData, setFormData] = useState({
    lastName: "",
    phoneNumber: "",
    city: "",
    streetAddress: "",
    privacyConsent: false,
  });

  const totalQuantity = cartItems
    .filter((item) => item.type === "–ü–∞—á–∫–∞")
    .reduce((acc, item) => acc + item.quantity, 0);

  const hasBlock = cartItems.some((item) => item.type === "–ë–ª–æ–∫");

  const onlyPacksAndBlocks = cartItems.every(
    (item) => item.type === "–ü–∞—á–∫–∞" || item.type === "–ë–ª–æ–∫"
  );

  const [errors, setErrors] = useState({});

  const validateForm = () => {
    const newErrors = {};

    if (!formData.lastName.trim()) {
      newErrors.lastName = "–í–≤–µ–¥–∏—Ç–µ –∏–º—è";
    }

    if (!formData.phoneNumber) {
      newErrors.phoneNumber = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞";
    } else if (formData.phoneNumber.replace(/\D/g, "").length < 11) {
      newErrors.phoneNumber = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞";
    }

    if (selectedMethod === "delivery") {
      if (!formData.city.trim()) {
        newErrors.city = "–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥";
      }

      if (!formData.streetAddress.trim()) {
        newErrors.streetAddress = "–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å";
      }
    }

    if (!formData.privacyConsent) {
      newErrors.privacyConsent =
        "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;

    let isValid = true;
    if (name === "lastName" || name === "city") {
      isValid = /^[–∞-—è–ê-–Ø—ë–Å\s-]*$/.test(value);
    } else if (name === "streetAddress") {
      isValid = /^[–∞-—è–ê-–Ø—ë–Å0-9\s-]*$/.test(value);
    }

    if (isValid) {
      setFormData((prev) => ({
        ...prev,
        [name]: value,
      }));
    }
  };

  const handleConsentChange = (e) => {
    setFormData((prev) => ({
      ...prev,
      privacyConsent: e.target.checked,
    }));
    if (errors.privacyConsent) {
      setErrors((prev) => ({
        ...prev,
        privacyConsent: "",
      }));
    }
  };

  const handlePhoneChange = (value) => {
    setFormData((prev) => ({
      ...prev,
      phoneNumber: value,
    }));
    if (errors.phoneNumber) {
      setErrors((prev) => ({
        ...prev,
        phoneNumber: "",
      }));
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    if (validateForm()) {
      const totalPrice = calculateTotalPrice();
      const site = "tereasticks.ru";

      const moscowCities = [
        "–º–æ—Å–∫–≤–∞",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
        "—Ç—Ä–æ–∏—Ü–∫",
        "–º–æ—Å–∫–æ–≤—Å–∫–∏–π",
        "—â–µ—Ä–±–∏–Ω–∫–∞",
        "–Ω–æ–≤–∞—è –º–æ—Å–∫–≤–∞",
        "—Ç–µ–ø–ª—ã–π —Å—Ç–∞–Ω",
        "–∫–æ–º–º—É–Ω–∞—Ä–∫–∞",
        "—Å–æ—Å–µ–Ω–∫–∏",
        "–±—É—Ç–æ–≤–æ",
        "–≤–Ω—É–∫–æ–≤–æ",
        "—Å–æ–ª–Ω—Ü–µ–≤–æ",
        "—Ñ–∏–ª–∏",
        "–Ω–æ–≤–æ–∫–æ—Å–∏–Ω–æ",
        "–¥–æ–º–æ–¥–µ–¥–æ–≤–æ",
        "–±–µ–ª—è–µ–≤–æ",
        "—è—Å–µ–Ω–µ–≤–æ",
        "—Ü–∞—Ä–∏—Ü—ã–Ω–æ",
        "–º–∞—Ä—å–∏–Ω–æ",
        "–ª—é–±–ª–∏–Ω–æ",
        "–≤–µ—à–Ω—è–∫–∏",
        "–ø–µ—á–∞—Ç–Ω–∏–∫–∏",
        "–∂—É–ª–µ–±–∏–Ω–æ",
        "–∫—É–∑—å–º–∏–Ω–∫–∏",
        "—á–µ—Ä—Ç–∞–Ω–æ–≤–æ",
        "—è–∫–∏–º–∞–Ω–∫–∞",
        "–∏–∑–º–∞–π–ª–æ–≤–æ",
        "–º–∏—Ç–∏–Ω–æ",
        "–∫—É—Ä–∫–∏–Ω–æ",
        "—Å–µ–≤–µ—Ä–Ω–æ–µ –±—É—Ç–æ–≤–æ",
        "—é–∂–Ω–æ–µ –±—É—Ç–æ–≤–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –¥–µ—Å–µ–Ω–æ–≤—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —Ñ–∏–ª–∏–º–æ–Ω–∫–æ–≤—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –º–∞—Ä—É—à–∫–∏–Ω—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –º–æ—Å—Ä–µ–Ω—Ç–≥–µ–Ω",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —Ä—è–∑–∞–Ω–æ–≤—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —Å–æ–∫–æ–ª–æ–≤–æ-–º–µ—â–µ—Ä—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —â–∞–ø–æ–≤—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω–æ–ø–∞—Ö–æ—Ä—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —â–µ—Ä–±–∏–Ω–∫–∞",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–º–∞–π—Å–∫–æ–µ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –º–æ—Å–∫–æ–≤—Å–∫–∏–π",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —Ç—Ä–æ–∏—Ü–∫",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ —à–∏—à–∫–∏–Ω –ª–µ—Å",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∫–∏—ë–≤—Å–∫–∏–π",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∫–∞–ª–∏–Ω–∏–Ω–µ—Ü",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∞–∫—Å–∏–Ω—å–∏–Ω–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –±—ã–ª–æ–≤–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –≤–∞—Ä–≤–∞—Ä–∏–Ω–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∫–æ–≥–æ—Ç–∫–æ–≤–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∫–ª–µ–Ω–æ–≤–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –≥–æ—Ä—á–∞–∫–æ–≤–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –∫—Ä–µ–∫—à–∏–Ω–æ",
        "–ø–æ—Å–µ–ª–µ–Ω–∏–µ –ª–µ—Å–Ω–æ–π –≥–æ—Ä–æ–¥–æ–∫",
        "—Ö–∏–º–∫–∏",
        "–º—ã—Ç–∏—â–∏",
        "–±–∞–ª–∞—à–∏—Ö–∞",
        "–ª—é–±–µ—Ä—Ü—ã",
        "—Ä–µ—É—Ç–æ–≤",
        "–∫–æ—Ä–æ–ª–µ–≤",
        "–æ–¥–∏–Ω—Ü–æ–≤–æ",
        "–¥–æ–ª–≥–æ–ø—Ä—É–¥–Ω—ã–π",
        "–≤–ª–∞—Å–∏—Ö–∞",
        "–≤–∏–¥–Ω–æ–µ",
        "—â–µ—Ä–±–∏–Ω–∫–∞",
        "–∫–æ—Ç–µ–ª—å–Ω–∏–∫–∏",
        "–Ω–æ–≤–æ–∫–æ—Å–∏–Ω–æ",
        "—ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å",
        "–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π",
        "–ª–∞–∑–∞—Ä–µ–≤–æ",
        "—Ç–µ–∫—Å—Ç–∏–ª—å—â–∏–∫–∏",
        "–Ω–æ–≤–æ–ø–µ—Ä–µ–¥–µ–ª–∫–∏–Ω–æ",
        "—Å–µ–≤–µ—Ä–Ω–æ–µ —Ç—É—à–∏–Ω–æ",
        // –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
        "–∞–ø—Ä–µ–ª–µ–≤–∫–∞",
        "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫",
        "–ª–µ–Ω–∏–Ω—Å–∫–∏–π",
        "–ø–æ–¥–æ–ª—å—Å–∫",
        "–¥–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π",
        "–¥–æ–ª–≥–æ–ø—Ä—É–¥–Ω—ã–π",
        "–ª–æ–±–Ω—è",
        "–∏–≤–∞–Ω—Ç–µ–µ–≤–∫–∞",
        "—Ñ—Ä—è–∑–∏–Ω–æ",
        "—Å–æ—Ñ—Ä–∏–Ω–æ",
        "–ø—É—à–∫–∏–Ω–æ",
        "—â–µ–ª–∫–æ–≤–æ",
        "–∂—É–∫–æ–≤—Å–∫–∏–π",
        "—Ä–∞–º–µ–Ω—Å–∫–æ–µ",
        "–±—Ä–æ–Ω–Ω–∏—Ü—ã",
        "–ª–∏–∫–∏–Ω–æ-–¥—É–ª–µ–≤–æ",
        "—ç–ª–µ–∫—Ç—Ä–æ–≥–æ—Ä—Å–∫",
        "–ø–∞–≤–ª–æ–≤—Å–∫–∏–π –ø–æ—Å–∞–¥",
        "—Å—Ç–∞—Ä–∞—è –∫—É–ø–∞–≤–Ω–∞",
        "–¥–º–∏—Ç—Ä–æ–≤",
        "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
        "–∫—É–±–∏–Ω–∫–∞",
        "–Ω–∞—Ä–æ-—Ñ–æ–º–∏–Ω—Å–∫",
        "—Ä—É–∑–∞",
        "–≤–æ–ª–æ–∫–æ–ª–∞–º—Å–∫",
        "–∏—Å—Ç—Ä–∞",
        "—á–µ—Ö–æ–≤",
        "—Å–µ—Ä–ø—É—Ö–æ–≤",
        "–∫–∞—à–∏—Ä–∞",
        "—Å—Ç–æ–ª–±–æ–≤–∞—è",
        "–ª–µ—Å–Ω–æ–π –≥–æ—Ä–æ–¥–æ–∫",
        "–ø–µ—Ä–µ–¥–µ–ª–∫–∏–Ω–æ",
        "–≤–Ω—É–∫–æ–≤–æ",
        "—Ä–∞–º–µ–Ω–∫–∏",
        "–∫–æ–Ω—å–∫–æ–≤–æ",
        "—Ç—ë–ø–ª—ã–π —Å—Ç–∞–Ω",
        "—è—Å–µ–Ω–µ–≤–æ",
        "–º–µ–¥–≤–µ–¥–∫–æ–≤–æ",
        "–∞–ª—Ç—É—Ñ—å–µ–≤–æ",
        "–±–∏–±–∏—Ä–µ–≤–æ",
        "–æ—Ç—Ä–∞–¥–Ω–æ–µ",
        "—Å–≤–∏–±–ª–æ–≤–æ",
        "–∞–ª–µ–∫—Å–µ–µ–≤—Å–∫–∏–π",
        "—Ä–∏–∂—Å–∫–∏–π",
        "–ø—Ä–æ—Å–ø–µ–∫—Ç –º–∏—Ä–∞",
        "—Å—É—â—ë–≤—Å–∫–∏–π",
        "–º–∞—Ä—Ñ–∏–Ω–æ",
        "–æ—Å—Ç–∞–Ω–∫–∏–Ω–æ",
        "—Ä–æ—Å—Ç–æ–∫–∏–Ω–æ",
        "—á–µ—Ä–∫–∏–∑–æ–≤–æ",
        "–ø—Ä–µ–æ–±—Ä–∞–∂–µ–Ω—Å–∫–æ–µ",
        "—Å–æ–∫–æ–ª—å–Ω–∏–∫–∏",
        "–±–æ–≥–æ—Ä–æ–¥—Å–∫–æ–µ",
        "–º–µ—Ç—Ä–æ–≥–æ—Ä–æ–¥–æ–∫",
        "–≥–æ–ª—å—è–Ω–æ–≤–æ",
        "–∏–∑–º–∞–π–ª–æ–≤–æ",
        "–≤–æ—Å—Ç–æ—á–Ω–æ–µ –∏–∑–º–∞–π–ª–æ–≤–æ",
        "—Å–µ–≤–µ—Ä–Ω–æ–µ –∏–∑–º–∞–π–ª–æ–≤–æ",
        "–∫–æ–≤—Ä–æ–≤–æ",
        "–ø–µ—Ä–æ–≤–æ",
        "–Ω–æ–≤–æ–≥–∏—Ä–µ–µ–≤–æ",
        "–≤–µ—à–Ω—è–∫–∏",
        "–≤—ã—Ö–∏–Ω–æ-–∂—É–ª–µ–±–∏–Ω–æ",
        "—Ä—é–º–∏–Ω–æ",
        "–∫–∞–ø–æ—Ç–Ω—è",
        "–∫—É–∑—å–º–∏–Ω–∫–∏",
        "–ª–µ—Ñ–æ—Ä—Ç–æ–≤–æ",
        "–Ω–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∏–π",
        "—Ç–µ–∫—Å—Ç–∏–ª—å—â–∏–∫–∏",
        "—é–∂–Ω–æ–ø–æ—Ä—Ç–æ–≤—ã–π",
        "–ø–µ—á–∞—Ç–Ω–∏–∫–∏",
        "–Ω–∞–≥–∞—Ç–∏–Ω–æ-—Å–∞–¥–æ–≤–Ω–∏–∫–∏",
        "–Ω–∞–≥–∞—Ç–∏–Ω—Å–∫–∏–π –∑–∞—Ç–æ–Ω",
        "–¥–∞–Ω–∏–ª–æ–≤—Å–∫–∏–π",
        "–¥–æ–Ω—Å–∫–æ–π",
        "–Ω–∞–≥–æ—Ä–Ω—ã–π",
        "–Ω–∞–≥–∞—Ç–∏–Ω–æ",
        "–∑—è–±–ª–∏–∫–æ–≤–æ",
        "–±—Ä–∞—Ç–µ–µ–≤–æ",
        "–∞–ª–º–∞-–∞—Ç–∏–Ω—Å–∫–∞—è",
        "–∫–∞–ª–∏—Ç–Ω–∏–∫–∏",
        "–∫–æ—Ç–ª–æ–≤–∫–∞",
        "–æ–±—Ä—É—á–µ–≤—Å–∫–∏–π",
        "–∫–æ–Ω—å–∫–æ–≤–æ",
        "–±–µ–ª—è–µ–≤–æ",
        "—á—ë—Ä—ë–º—É—à–∫–∏",
        "–∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π",
        "–≥–∞–≥–∞—Ä–∏–Ω—Å–∫–∏–π",
        "–ª–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç",
        "—è–∫–∏–º–∞–Ω–∫–∞",
        "–∞—Ä–±–∞—Ç",
        "–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π",
        "—Ç–≤–µ—Ä—Å–∫–æ–π",
        "–º–µ—â–∞–Ω—Å–∫–∏–π",
        "–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π",
        "–±–∞—Å–º–∞–Ω–Ω—ã–π",
        "—Ç–∞–≥–∞–Ω—Å–∫–∏–π",
        "–∑–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ",
        "—Ö–∞–º–æ–≤–Ω–∏–∫–∏",
        "—è–∫–∏–º–∞–Ω–∫–∞",
        "–∫—Ä—ã–ª–∞—Ç—Å–∫–æ–µ",
        "–∫—É–Ω—Ü–µ–≤–æ",
        "—Ñ–∏–ª—ë–≤—Å–∫–∏–π –ø–∞—Ä–∫",
        "—Ñ–∏–ª–∏-–¥–∞–≤—ã–¥–∫–æ–≤–æ",
        "–¥–æ—Ä–æ—Ö–æ–≤–æ",
        "—Å–µ—Ç—É–Ω—å",
        "–ø—Ä–æ—Ç–≤–∏–Ω–æ",
        "–ø—É—â–∏–Ω–æ",
        "—Å–µ—Ä–≥–∏–µ–≤ –ø–æ—Å–∞–¥",
        "–∫—Ä–∞—Å–Ω–æ–∑–∞–≤–æ–¥—Å–∫",
        "–ø–µ—Ä–µ—Å–≤–µ—Ç",
        "—Ö–æ—Ç–æ–≤–æ",
        "–∞–±—Ä–∞–º—Ü–µ–≤–æ",
        "—Å–æ—Ñ—Ä–∏–Ω–æ",
        "–ø—É—à–∫–∏–Ω–æ",
        "–∏–≤–∞–Ω—Ç–µ–µ–≤–∫–∞",
        "—Ñ—Ä—è–∑–∏–Ω–æ",
        "–∫–æ—Ä–æ–ª—ë–≤",
        "—é–±–∏–ª–µ–π–Ω—ã–π",
        "–ª–æ—Å–∏–Ω–æ-–ø–µ—Ç—Ä–æ–≤—Å–∫–∏–π",
        "–º–æ–Ω–∏–Ω–æ",
        "—â—ë–ª–∫–æ–≤–æ",
        "—Ñ—Ä–∏–¥—Ä–∏—Ö—Å–≥–∞–º",
        "—Å—Ç–∞—Ä–∞—è –∫—É–ø–∞–≤–Ω–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ—É–≥–ª–∏",
        "–ª–∏–∫–∏–Ω–æ-–¥—É–ª—ë–≤–æ",
        "–¥–∞–≤—ã–¥–æ–≤–æ",
        "–∫—É—Ä–æ–≤—Å–∫–æ–µ",
        "–µ–≥–æ—Ä—å–µ–≤—Å–∫",
        "–∫–æ–ª–æ–º–Ω–∞",
        "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫",
        "–±–µ–ª–æ–æ–∑—ë—Ä—Å–∫–∏–π",
        "—Ö–æ—Ä–ª–æ–≤–æ",
        "—Ä–∞–º–µ–Ω—Å–∫–æ–µ",
        "–∂—É–∫–æ–≤—Å–∫–∏–π",
        "–±—ã–∫–æ–≤–æ",
        "–∫—Ä–∞—Å–∫–æ–≤–æ",
        "–º–∞–ª–∞—Ö–æ–≤–∫–∞",
        "—É–¥–µ–ª—å–Ω–∞—è",
        "—Ç–æ–º–∏–ª–∏–Ω–æ",
        "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫",
        "–Ω–∞—Ö–∞–±–∏–Ω–æ",
        "–æ–ø–∞–ª–∏—Ö–∞",
        "–∞—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–æ–µ",
        "–∏–ª—å–∏–Ω—Å–∫–æ–µ",
        "—Å—Ç–µ–ø–∞–Ω–æ–≤–æ",
        "–¥–µ–¥–æ–≤—Å–∫",
        "—Å–Ω–µ–≥–∏—Ä–∏",
        "—Ö–æ–ª–º–æ–≥–æ—Ä–∫–∞",
        "–ª–µ—Å–Ω–æ–π",
        "–ø–æ–≤–∞—Ä–æ–≤–æ",
        "–∞–Ω–¥—Ä–µ–µ–≤–∫–∞",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
        "–∫—Ä—é–∫–æ–≤–æ",
        "—Å–∞–≤—ë–ª–∫–∏",
        "—Å–∏–ª–∏–Ω–æ",
        "—Å—Ç–∞—Ä–æ–µ –∫—Ä—é–∫–æ–≤–æ",
        "–∞–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∫–∞",
        "–ª—É–∂–Ω–∏–∫–∏",
        "–º–∞—Ç–≤–µ–µ–≤—Å–∫–æ–µ",
        "–æ—á–∞–∫–æ–≤–æ",
        "–Ω–æ–≤–æ-–ø–µ—Ä–µ–¥–µ–ª–∫–∏–Ω–æ",
        "—Å–æ–ª–Ω—Ü–µ–≤–æ",
        "–≤–æ—Ä–æ–±—å—ë–≤—ã –≥–æ—Ä—ã",
        "–ª–µ–Ω–∏–Ω—Å–∫–∏–µ –≥–æ—Ä—ã",
        "—Ä–∞–º–µ–Ω–∫–∏",
        "–ø—Ä–æ—Å–ø–µ–∫—Ç –≤–µ—Ä–Ω–∞–¥—Å–∫–æ–≥–æ",
        "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
        "—á–µ—Ä—ë–º—É—à–∫–∏",
        "–Ω–æ–≤—ã–µ —á–µ—Ä—ë–º—É—à–∫–∏",
        "–∑—é–∑–∏–Ω–æ",
        "–∫–æ—Ç–ª–æ–≤–∫–∞",
        "–æ–±—Ä—É—á–µ–≤—Å–∫–∏–π",
        "–≥–∞–≥–∞—Ä–∏–Ω—Å–∫–∏–π",
        "–ª–µ–Ω–∏–Ω—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç",
        "—è–∫–∏–º–∞–Ω–∫–∞",
        "–∞—Ä–±–∞—Ç",
        "–ø—Ä–µ—Å–Ω–µ–Ω—Å–∫–∏–π",
        "—Ç–≤–µ—Ä—Å–∫–æ–π",
        "–º–µ—â–∞–Ω—Å–∫–∏–π",
        "–∫—Ä–∞—Å–Ω–æ—Å–µ–ª—å—Å–∫–∏–π",
        "–±–∞—Å–º–∞–Ω–Ω—ã–π",
        "—Ç–∞–≥–∞–Ω—Å–∫–∏–π",
        "–∑–∞–º–æ—Å–∫–≤–æ—Ä–µ—á—å–µ",
        "—Ö–∞–º–æ–≤–Ω–∏–∫–∏",
        "—è–∫–∏–º–∞–Ω–∫–∞",
        "–∫—Ä—ã–ª–∞—Ç—Å–∫–æ–µ",
        "–∫—É–Ω—Ü–µ–≤–æ",
        "—Ñ–∏–ª—ë–≤—Å–∫–∏–π –ø–∞—Ä–∫",
        "—Ñ–∏–ª–∏-–¥–∞–≤—ã–¥–∫–æ–≤–æ",
        "–¥–æ—Ä–æ—Ö–æ–≤–æ",
        "—Å–µ—Ç—É–Ω—å",
        "—Ç—Ä–æ–∏—Ü–∫",
        "–∫—Ä–∞—Å–Ω–∞—è –ø–∞—Ö—Ä–∞",
        "–∫–ª—ë–Ω–æ–≤–æ",
        "–ø–µ—Ä–≤–æ–º–∞–π—Å–∫–æ–µ",
        "–∫–∏–µ–≤—Å–∫–∏–π",
        "—â–µ—Ä–±–∏–Ω–∫–∞",
        "–ø–æ–¥–æ–ª—å—Å–∫",
        "–∫–ª–∏–º–æ–≤—Å–∫",
        "—á–µ—Ö–æ–≤",
        "—Å–µ—Ä–ø—É—Ö–æ–≤",
        "–ø—Ä–æ—Ç–≤–∏–Ω–æ",
        "–ø—É—â–∏–Ω–æ",
        "–ª–∏–ø–∏—Ü—ã",
        "–æ–±–æ–ª–µ–Ω—Å–∫",
        "—Ç–∞—Ä—É—Å–∞",
        "–∞–ø—Ä–µ–ª–µ–≤–∫–∞",
        "–∫–æ–∫–æ—à–∫–∏–Ω–æ",
        "–ª–µ—Å–Ω–æ–π –≥–æ—Ä–æ–¥–æ–∫",
        "–∞–ø—Ä–µ–ª–µ–≤–∫–∞",
        "—Å–µ–ª—è—Ç–∏–Ω–æ",
        "–Ω–∞—Ä–æ-—Ñ–æ–º–∏–Ω—Å–∫",
        "–∫—É–±–∏–Ω–∫–∞",
        "—Ç–µ–ø–ª–æ–≤–∫–∞",
        "–∑–∏–º—ë–Ω–∫–∏",
        "–∂—É–∫–æ–≤–∫–∞",
        "–Ω–∏–∫–æ–ª—å—Å–∫–æ–µ",
        "–ø–µ—Ç—Ä–æ–≤–æ-–¥–∞–ª—å–Ω–µ–µ",
        "–∏–ª—å–∏–Ω—Å–∫–æ–µ",
        "–ø–∞–≤–ª–æ–≤—Å–∫–∞—è —Å–ª–æ–±–æ–¥–∞",
        "–±—É–∑–ª–∞–Ω–æ–≤–æ",
        "—Å–Ω–µ–≥–∏—Ä–∏",
        "–¥—É–±–∫–∏",
        "–∂—É–∫–æ–≤–∫–∞",
        "–≥–æ—Ä–∫–∏-10",
        "–±–∞—Ä–≤–∏—Ö–∞",
        "—Ä–∞–∑–¥–æ—Ä—ã",
        "—É–ª—å—è–Ω–æ–≤–∫–∞",
        "–≥–æ—Ä–∫–∏-2",
        "–∑–∞—Ä–µ—á—å–µ",
        "–¥–º–∏—Ç—Ä–æ–≤",
        "—è—Ö—Ä–æ–º–∞",
        "–¥–æ–ª–≥–∏–µ –ø—Ä—É–¥—ã",
        "–ª—å–≤–æ–≤—Å–∫–∏–π",
        "–≥–æ—Ä—à–∫–æ–≤–æ",
        "—Å—Ö–æ–¥–Ω—è",
        "—Ñ–∏—Ä—Å–∞–Ω–æ–≤–∫–∞",
        "–ø–æ–¥—Ä–µ–∑–∫–æ–≤–æ",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
        "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫",
        "–ø–æ–≤–∞—Ä–æ–≤–æ",
        "–∞–Ω–¥—Ä–µ–µ–≤–∫–∞",
        "–ø–æ–≤–µ–¥–Ω–∏–∫–∏",
        "–∫—É–ø–∞–≤–Ω–∞",
        "—Å—Ç–∞—Ä–∞—è –∫—É–ø–∞–≤–Ω–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ—É–≥–ª–∏",
        "—ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å",
        "–Ω–æ–≥–∏–Ω—Å–∫",
        "–ø–∞–≤–ª–æ–≤—Å–∫–∏–π –ø–æ—Å–∞–¥",
        "—ç–ª–µ–∫—Ç—Ä–æ–≥–æ—Ä—Å–∫",
        "–ª–∏–∫–∏–Ω–æ-–¥—É–ª—ë–≤–æ",
        "–¥–∞–≤—ã–¥–æ–≤–æ",
        "–∫—É—Ä–æ–≤—Å–∫–æ–µ",
        "–µ–≥–æ—Ä—å–µ–≤—Å–∫",
        "–∫–æ–ª–æ–º–Ω–∞",
        "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫",
        "–±–µ–ª–æ–æ–∑—ë—Ä—Å–∫–∏–π",
        "—Ö–æ—Ä–ª–æ–≤–æ",
        "—Ä–∞–º–µ–Ω—Å–∫–æ–µ",
        "–∂—É–∫–æ–≤—Å–∫–∏–π",
        "–±—ã–∫–æ–≤–æ",
        "–∫—Ä–∞—Å–∫–æ–≤–æ",
        "–º–∞–ª–∞—Ö–æ–≤–∫–∞",
        "—É–¥–µ–ª—å–Ω–∞—è",
        "—Ç–æ–º–∏–ª–∏–Ω–æ",
        "–ª—é–±–µ—Ä—Ü—ã",
        "–∫–æ—Ç–µ–ª—å–Ω–∏–∫–∏",
        "–¥–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π",
        "–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π",
        "–±–∞–ª–∞—à–∏—Ö–∞",
        "—Ä–µ—É—Ç–æ–≤",
        "—â–µ–ª–∫–æ–≤–æ",
        "—Ñ—Ä—è–∑–∏–Ω–æ",
        "–∫–æ—Ä–æ–ª—ë–≤",
        "–º—ã—Ç–∏—â–∏",
        "–ø—É—à–∫–∏–Ω–æ",
        "–∏–≤–∞–Ω—Ç–µ–µ–≤–∫–∞",
        "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫",
        "—Ö–∏–º–∫–∏",
        "–¥–æ–ª–≥–æ–ø—Ä—É–¥–Ω—ã–π",
        "–ª–æ–±–Ω—è",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
        "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫",
        "–∫–ª–∏–Ω",
        "–≤—ã—Å–æ–∫–æ–≤—Å–∫",
        "—Ç–µ—Ä—è–µ–≤–æ",
        "–ø–æ–∫—Ä–æ–≤–∫–∞",
        "–Ω–æ–≤–æ–ø–µ—Ç—Ä–æ–≤—Å–∫–æ–µ",
        "–∏—Å—Ç—Ä–∞",
        "–¥–µ–¥–æ–≤—Å–∫",
        "—Å–Ω–µ–≥–∏—Ä–∏",
        "—Ö–æ–ª–º–æ–≥–æ—Ä–∫–∞",
        "–ª–µ—Å–Ω–æ–π",
        "–ø–æ–≤–∞—Ä–æ–≤–æ",
        "–∞–Ω–¥—Ä–µ–µ–≤–∫–∞",
        "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫",
        "–ø–æ–≤–∞—Ä–æ–≤–æ",
        "–∞–Ω–¥—Ä–µ–µ–≤–∫–∞",
        "–ø–æ–≤–µ–¥–Ω–∏–∫–∏",
        "–∫—É–ø–∞–≤–Ω–∞",
        "—Å—Ç–∞—Ä–∞—è –∫—É–ø–∞–≤–Ω–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ—É–≥–ª–∏",
        "—ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å",
        "–Ω–æ–≥–∏–Ω—Å–∫",
        "–ø–∞–≤–ª–æ–≤—Å–∫–∏–π –ø–æ—Å–∞–¥",
        "—ç–ª–µ–∫—Ç—Ä–æ–≥–æ—Ä—Å–∫",
        "–ª–∏–∫–∏–Ω–æ-–¥—É–ª—ë–≤–æ",
        "–¥–∞–≤—ã–¥–æ–≤–æ",
        "–∫—É—Ä–æ–≤—Å–∫–æ–µ",
        "–µ–≥–æ—Ä—å–µ–≤—Å–∫",
        "–∫–æ–ª–æ–º–Ω–∞",
        "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫",
        "–±–µ–ª–æ–æ–∑—ë—Ä—Å–∫–∏–π",
        "—Ö–æ—Ä–ª–æ–≤–æ",
        "—Ä–∞–º–µ–Ω—Å–∫–æ–µ",
        "–∂—É–∫–æ–≤—Å–∫–∏–π",
        "–±—ã–∫–æ–≤–æ",
        "–∫—Ä–∞—Å–∫–æ–≤–æ",
        "–º–∞–ª–∞—Ö–æ–≤–∫–∞",
        "—É–¥–µ–ª—å–Ω–∞—è",
        "—Ç–æ–º–∏–ª–∏–Ω–æ",
        "–ª—é–±–µ—Ä—Ü—ã",
        "–∫–æ—Ç–µ–ª—å–Ω–∏–∫–∏",
        "–¥–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π",
        "–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π",
        "–±–∞–ª–∞—à–∏—Ö–∞",
        "—Ä–µ—É—Ç–æ–≤",
        "—â–µ–ª–∫–æ–≤–æ",
        "—Ñ—Ä—è–∑–∏–Ω–æ",
        "–∫–æ—Ä–æ–ª—ë–≤",
        "–º—ã—Ç–∏—â–∏",
        "–ø—É—à–∫–∏–Ω–æ",
        "–∏–≤–∞–Ω—Ç–µ–µ–≤–∫–∞",
        "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫",
        "—Ö–∏–º–∫–∏",
        "–¥–æ–ª–≥–æ–ø—Ä—É–¥–Ω—ã–π",
        "–ª–æ–±–Ω—è",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
        "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫",
        "–∫–ª–∏–Ω",
        "–≤—ã—Å–æ–∫–æ–≤—Å–∫",
        "—Ç–µ—Ä—è–µ–≤–æ",
        "–ø–æ–∫—Ä–æ–≤–∫–∞",
        "–Ω–æ–≤–æ–ø–µ—Ç—Ä–æ–≤—Å–∫–æ–µ",
        "–∏—Å—Ç—Ä–∞",
        "–¥–µ–¥–æ–≤—Å–∫",
        "—Å–Ω–µ–≥–∏—Ä–∏",
        "—Ö–æ–ª–º–æ–≥–æ—Ä–∫–∞",
        "–ª–µ—Å–Ω–æ–π",
        "–ø–æ–≤–∞—Ä–æ–≤–æ",
        "–∞–Ω–¥—Ä–µ–µ–≤–∫–∞",
        "—Å–æ–ª–Ω–µ—á–Ω–æ–≥–æ—Ä—Å–∫",
        "–ø–æ–≤–∞—Ä–æ–≤–æ",
        "–∞–Ω–¥—Ä–µ–µ–≤–∫–∞",
        "–ø–æ–≤–µ–¥–Ω–∏–∫–∏",
        "–∫—É–ø–∞–≤–Ω–∞",
        "—Å—Ç–∞—Ä–∞—è –∫—É–ø–∞–≤–Ω–∞",
        "—ç–ª–µ–∫—Ç—Ä–æ—É–≥–ª–∏",
        "—ç–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–ª—å",
        "–Ω–æ–≥–∏–Ω—Å–∫",
        "–ø–∞–≤–ª–æ–≤—Å–∫–∏–π –ø–æ—Å–∞–¥",
        "—ç–ª–µ–∫—Ç—Ä–æ–≥–æ—Ä—Å–∫",
        "–ª–∏–∫–∏–Ω–æ-–¥—É–ª—ë–≤–æ",
        "–¥–∞–≤—ã–¥–æ–≤–æ",
        "–∫—É—Ä–æ–≤—Å–∫–æ–µ",
        "–µ–≥–æ—Ä—å–µ–≤—Å–∫",
        "–∫–æ–ª–æ–º–Ω–∞",
        "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—Å–∫",
        "–±–µ–ª–æ–æ–∑—ë—Ä—Å–∫–∏–π",
        "—Ö–æ—Ä–ª–æ–≤–æ",
        "—Ä–∞–º–µ–Ω—Å–∫–æ–µ",
        "–∂—É–∫–æ–≤—Å–∫–∏–π",
        "–±—ã–∫–æ–≤–æ",
        "–∫—Ä–∞—Å–∫–æ–≤–æ",
        "–º–∞–ª–∞—Ö–æ–≤–∫–∞",
        "—É–¥–µ–ª—å–Ω–∞—è",
        "—Ç–æ–º–∏–ª–∏–Ω–æ",
        "–ª—é–±–µ—Ä—Ü—ã",
        "–∫–æ—Ç–µ–ª—å–Ω–∏–∫–∏",
        "–¥–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π",
        "–∂–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π",
        "–±–∞–ª–∞—à–∏—Ö–∞",
        "—Ä–µ—É—Ç–æ–≤",
        "—â–µ–ª–∫–æ–≤–æ",
        "—Ñ—Ä—è–∑–∏–Ω–æ",
        "–∫–æ—Ä–æ–ª—ë–≤",
        "–º—ã—Ç–∏—â–∏",
        "–ø—É—à–∫–∏–Ω–æ",
        "–∏–≤–∞–Ω—Ç–µ–µ–≤–∫–∞",
        "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫",
        "—Ö–∏–º–∫–∏",
        "–¥–æ–ª–≥–æ–ø—Ä—É–¥–Ω—ã–π",
        "–ª–æ–±–Ω—è",
        "–∑–µ–ª–µ–Ω–æ–≥—Ä–∞–¥",
      ];

      const formattedCart = cartItems
        .map(
          (item) =>
            `- ${item.name} (${item.type || "–æ–±—ã—á–Ω—ã–π"}) x${item.quantity}: ${
              item.price
            } ‚ÇΩ`
        )
        .join("\n");

      const message = `
–ó–∞–∫–∞–∑ —Å —Å–∞–π—Ç–∞ ${site}

–ò–º—è: ${formData.lastName}   
–¢–µ–ª–µ—Ñ–æ–Ω: +${formData.phoneNumber}
–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏: ${selectedMethod === "delivery" ? "–î–æ—Å—Ç–∞–≤–∫–∞" : "–°–∞–º–æ–≤—ã–≤–æ–∑"}
${
  selectedMethod === "delivery"
    ? `–ì–æ—Ä–æ–¥: ${formData.city}\n–ê–¥—Ä–µ—Å: ${formData.streetAddress}`
    : ""
}

–ö–æ—Ä–∑–∏–Ω–∞:
${formattedCart}

–û–±—â–∞—è —Å—É–º–º–∞: ${totalPrice} ‚ÇΩ
    `;

      let mess = "";
      if (selectedMethod === "pickup") {
        mess = `–î–æ–±—Ä—ã–π –¥–µ–Ω—å!\n\n –ü–æ–ª—É—á–∏–ª–∏ –≤–∞—à –∑–∞–∫–∞–∑ ‚úÖ \n\n  —Å —Å–∞–π—Ç–∞ ${site} ‚úÖ\n\n–ù–∞—à –∞–¥—Ä–µ—Å –¥–ª—è —Å–∞–º–æ–≤—ã–≤–æ–∑–∞:\n–ì.–ú–æ—Å–∫–≤–∞\n\n –†–∏–º—Å–∫–æ–≥–æ-–ö–æ—Ä—Å–∞–∫–æ–≤–∞ 11–∫8\n–û—Ä–∏–µ–Ω—Ç–∏—Ä –ø—É–Ω–∫—Ç ¬´OZON¬ª\n\n–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ ‚ùóÔ∏è‚ùóÔ∏è\n\n –í–∞–∂–Ω–æ‚ùóÔ∏è‚ùóÔ∏è\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–∞–Ω–µ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –¥–∞—Ç—É –∏ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–µ–∑–¥–∞.\–¢ –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏, –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞—à –∑–∞–∫–∞–∑ –Ø–Ω–¥–µ–∫—Å –∫—É—Ä—å–µ—Ä–æ–º –∏–ª–∏ –î–æ—Å—Ç–∞–≤–∏—Å—Ç–æ–π. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ, –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –∫–∞—Ä—Ç—É. \n\n–ö–æ—Ä–∑–∏–Ω–∞:\n${formattedCart} \n\n–ò–º—è: ${formData.lastName}\n–¢–µ–ª–µ—Ñ–æ–Ω: +${formData.phoneNumber}\nTelegram: ${telegramUsername}`;
      } else if (
        selectedMethod === "delivery" &&
        moscowCities.some((city) =>
          formData.city.trim().toLowerCase().includes(city)
        )
      ) {
        mess = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n–ü–æ–ª—É—á–∏–ª–∏ –≤–∞—à –∑–∞–∫–∞–∑ —Å —Å–∞–π—Ç–∞ ${site} ‚úÖ\n\n–ó–∞–∫–∞–∑—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å –∏–ª–∏ –î–æ—Å—Ç–∞–≤–∏—Å—Ç—É, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–≤ —Å –≤–∞–º–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏. –û–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑ - –ø–µ—Ä–µ–≤–æ–¥–æ–º –Ω–∞ –∫–∞—Ä—Ç—É.\n\n–ú–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ª—é–±–æ–µ —É–¥–æ–±–Ω–æ–µ –¥–ª—è –í–∞—Å –≤—Ä–µ–º—è.\n\n‚ùóÔ∏è–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—å–µ—Ä—É –î–æ—Å—Ç–∞–≤–∏—Å—Ç—ã (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ú–ö–ê–î)\n\n–ö–æ–≥–¥–∞ –í–∞–º –±—ã–ª–æ –±—ã —É–¥–æ–±–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑? üòä\n\n–ö–æ—Ä–∑–∏–Ω–∞:\n${formattedCart} \n\n–ê–¥—Ä–µ—Å \n\n–ì–æ—Ä–æ–¥: ${formData.city}\n–ê–¥—Ä–µ—Å: ${formData.streetAddress}`;
      } else if (selectedMethod === "delivery") {
        mess = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n–ü–æ–ª—É—á–∏–ª–∏ –≤–∞—à –∑–∞–∫–∞–∑ —Å —Å–∞–π—Ç–∞ ${site} ‚úÖ\n\n–í —Ä–µ–≥–∏–æ–Ω—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ CDEK. –ü—Ä–æ—Ü–µ—Å—Å —Å–ª–µ–¥—É—é—â–∏–π:\n\n–í—ã—Å—ã–ª–∞–µ–º —Ñ–æ—Ç–æ –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞ –∏ –Ω–∞–∫–ª–∞–¥–Ω—É—é Cdek (–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É, —Ç–∞—Ä–∏—Ñ—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ, –¥–æ—Å—Ç–∞–≤–∫–∞ –±—É–¥–µ—Ç –æ–ø–ª–∞—á–µ–Ω–∞ –Ω–∞–º–∏ —Å—Ä–∞–∑—É –∏ –≤–∫–ª—é—á–µ–Ω–∞ –≤ –æ–±—â–∏–π —Å—á–µ—Ç).\n–í—ã—Å—ã–ª–∞–µ–º –≤–∞–º —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n\n–í—Å–µ –ø–æ—Å—ã–ª–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –¥–µ–Ω—å –∑–∞–∫–∞–∑–∞.\n–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑ –ú–æ—Å–∫–≤—ã ‚ùóÔ∏è\n–ù–∞–ª–æ–∂–µ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–æ–º –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º ‚ùå‚ùå‚ùå\n\n–û—Ç –í–∞—Å –Ω—É–∂–Ω—ã —Å–ª–µ–¥ –¥–∞–Ω–Ω—ã–µ:\n\n–§–ò–û \n–ê–¥—Ä–µ—Å –±–ª–∏–∂ –ü–í–ó –°–î–≠–ö\n\n–ö–æ—Ä–∑–∏–Ω–∞:\n${formattedCart} \n\n–ì–æ—Ä–æ–¥: ${formData.city}\n–ê–¥—Ä–µ—Å: ${formData.streetAddress}`;
      }

      try {
        const response = await fetch("/api/telegram-proxi", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            chat_id: "-1002155675591",
            text: message,
            parse_mode: "Markdown",
          }),
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Telegram error: ${JSON.stringify(errorData)}`);
        }

        const result = await response.json();
        console.log("Telegram response:", result);

        const idInstance = "1103290542";
        const apiTokenInstance =
          "65dee4a31f1342768913a5557afc548591af648dffc44259a6";
        fetch(
          `https://api.green-api.com/waInstance${idInstance}/SendMessage/${apiTokenInstance}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chatId: `${formData.phoneNumber}@c.us`,
              message: mess,
            }),
          }
        );

        if (response.ok) {
          console.log("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram –∏ WhatsApp!");
          alert(
            "–í–∞—à –∑–∞–∫–∞–∑ –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä."
          );
          window.location.href = "/";
          clearCart();
        } else {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram");
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API", error);
      }
    }

    setLoading(false);
  };

  const handleExternalSubmit = () => {
    if (formRef.current) {
      formRef.current.requestSubmit();
    }
  };

  return (
    <div className="checkout-page">
      <div className="checkout-form">
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
        <form onSubmit={handleSubmit} ref={formRef}>
          <div className="checkout-name">
            <h4>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
            <input
              type="text"
              name="lastName"
              placeholder="–í–∞—à–µ –∏–º—è"
              value={formData.lastName}
              onChange={handleInputChange}
            />
            {errors.lastName && (
              <p className="error" style={{ color: "red" }}>
                {errors.lastName}
              </p>
            )}

            <PhoneInput
              country={"ru"}
              value={formData.phoneNumber}
              onChange={handlePhoneChange}
              disableDropdown={true}
              onlyCountries={["ru"]}
              inputStyle={{
                width: "100%",
                fontSize: "16px",
                padding: "10px 20px",
                fontFamily: "inherit",
              }}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"
            />
            {errors.phoneNumber && (
              <p className="error" style={{ color: "red" }}>
                {errors.phoneNumber}
              </p>
            )}
          </div>

          <div className="checkout-delivery">
            <h4>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</h4>
            <div className="checkout-delivery-method">
              <button
                type="button"
                className={selectedMethod === "pickup" ? "active" : ""}
                onClick={() => setSelectedMethod("pickup")}
              >
                –°–∞–º–æ–≤—ã–≤–æ–∑
              </button>
              {onlyPacksAndBlocks && totalQuantity < 10 && !hasBlock ? (
                <button type="button" className={selectedMethod} disabled>
                  –î–æ—Å—Ç–∞–≤–∫–∞<br></br>
                  <span style={{ fontSize: "14px", color: "rgb(198, 58, 58)" }}>
                    –ù—É–∂–Ω–æ 10 –ø–∞—á–µ–∫ –∏–ª–∏ –±–ª–æ–∫
                  </span>
                </button>
              ) : (
                <button
                  type="button"
                  className={selectedMethod === "delivery" ? "active" : ""}
                  onClick={() => setSelectedMethod("delivery")}
                >
                  –î–æ—Å—Ç–∞–≤–∫–∞
                </button>
              )}
            </div>

            {selectedMethod === "delivery" && (
              <div className="checkout-delivery-address">
                <input
                  type="text"
                  name="city"
                  placeholder="–ì–æ—Ä–æ–¥"
                  value={formData.city}
                  onChange={handleInputChange}
                />
                {errors.city && (
                  <p className="error" style={{ color: "red" }}>
                    {errors.city}
                  </p>
                )}

                <input
                  type="text"
                  name="streetAddress"
                  placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã"
                  value={formData.streetAddress}
                  onChange={handleInputChange}
                />
                {errors.streetAddress && (
                  <p className="error" style={{ color: "red" }}>
                    {errors.streetAddress}
                  </p>
                )}
              </div>
            )}

            {selectedMethod === "pickup" && (
              <div className="checkout-delivery-pickup">
                <p>
                  –ó–∞–±–∏—Ä–∞—Ç—å –∑–∞–∫–∞–∑ –ø–æ –∞–¥—Ä–µ—Å—É:
                  <br />
                  –≥.–ú–æ—Å–∫–≤–∞ - —É–ª. –†–∏–º—Å–∫–æ–≥–æ-–ö–æ—Ä—Å–∞–∫–æ–≤–∞, 11, –∫–æ—Ä–ø 8 –û—Ä–∏–µ–Ω—Ç–∏—Ä: –ü—É–Ω–∫—Ç
                  "OZON" (–°–ê–ú–û–í–´–í–û–ó –û–°–£–©–ï–°–¢–í–õ–Ø–ï–¢–°–Ø –ü–û –°–û–ì–õ–ê–°–û–í–ê–ù–ò–Æ)
                </p>
                {/* <p>–°–∞–º–æ–≤—ã–≤–æ–∑ –ø–æ —Ç–µ—Ö. –ø—Ä–∏—á–∏–Ω–∞–º –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p> */}
              </div>
            )}
          </div>
        </form>
      </div>

      <div className="checkout-table">
        <h4>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h4>
        {cartItems.length > 0 ? (
          <div>
            <ul className="cart-list">
              {cartItems.map((item) => (
                <li key={item.id} className="cart-item">
                  <img
                    src={item.image}
                    alt={item.name}
                    className="cart-item-image"
                  />
                  <div className="cart-item-info">
                    <div className="cart-item-name">
                      <p>{item.name}</p>
                      {item.type === "default" ? "" : <p>({item.type})</p>}
                    </div>
                    <div className="price">
                      <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {item.quantity}</p>
                      <p>–¶–µ–Ω–∞: {item.price} ‚ÇΩ</p>
                    </div>
                  </div>
                </li>
              ))}
            </ul>
            <div className="checkout-total">
              <p>–ò—Ç–æ–≥–æ:</p>
              <p>{calculateTotalPrice()} ‚ÇΩ</p>
            </div>
            <div className="checkout-privacy">
              <label
                style={{
                  display: "flex",
                  alignItems: "center",
                  gap: "5px",
                  marginBottom: "15px",
                  fontSize: "14px",
                }}
              >
                <input
                  type="checkbox"
                  checked={formData.privacyConsent}
                  onChange={handleConsentChange}
                  style={{ width: "auto" }}
                />

                <Link
                  href="/policy"
                  style={{ color: "grey", textDecoration: "underline" }}
                >
                  –î–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–≤–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                </Link>
              </label>
              {errors.privacyConsent && (
                <p
                  className="error"
                  style={{ color: "red", fontSize: "12px", marginTop: "4px" }}
                >
                  {errors.privacyConsent}
                </p>
              )}
            </div>
            <button onClick={handleExternalSubmit} disabled={loading}>
              {loading ? "–ó–∞–≥—Ä—É–∑–∫–∞..." : "–ó–∞–∫–∞–∑–∞—Ç—å"}
            </button>
          </div>
        ) : (
          <div>
            <h5 style={{ textAlign: "center", marginTop: "30%" }}>
              –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
            </h5>
          </div>
        )}
      </div>
    </div>
  );
};

export default CheckoutPage;
